name: ☕ Backend CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: "17"

jobs:
  # Job 1: Code Quality & Testing
  quality-check:
    name: 🔍 Code Quality & Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
        
    - name: 🔐 Make mvnw executable
      run: chmod +x mvnw
      
    - name: 📦 Compile & Package
      run: |
        ./mvnw clean compile -q
        ./mvnw package -DskipTests -q
        
    - name: 🧪 Run Unit Tests
      run: |
        # Run tests with H2 for unit tests (faster)
        ./mvnw test \
          -Dspring.datasource.url=jdbc:h2:mem:testdb \
          -Dspring.datasource.username=sa \
          -Dspring.datasource.password=password \
          -Dspring.datasource.driver-class-name=org.h2.Driver \
          -Dspring.jpa.hibernate.ddl-auto=create-drop
        
    - name: 📊 Test Coverage Report
      run: |
        ./mvnw jacoco:report
      continue-on-error: true
      
    - name: 📈 Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.sha }}
        path: |
          ./target/surefire-reports/
          ./target/site/jacoco/
        retention-days: 7
        
    - name: 📦 Upload JAR Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: backend-jar-${{ github.sha }}
        path: ./target/*.jar
        retention-days: 7

  # Job 2: Security & Dependency Check
  security-scan:
    name: 🔒 Security & Dependency Scan
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
        
    - name: 🔐 Make mvnw executable
      run: chmod +x mvnw
      
    - name: 🔍 OWASP Dependency Check
      run: |
        ./mvnw org.owasp:dependency-check-maven:check
      continue-on-error: true

  # Job 3: API Documentation & Swagger
  api-docs:
    name: 📚 API Documentation
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
        
    - name: 🔐 Make mvnw executable
      run: chmod +x mvnw
      
    - name: 🗄️ Test PostgreSQL Connection
      run: |
        # Install PostgreSQL client
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
        # Debug: Check if secret is available
        if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
          echo "❌ DB_PASSWORD secret is empty or not available"
          echo "This could be a permission issue with repository secrets"
          exit 1
        else
          echo "✅ DB_PASSWORD secret is available"
        fi
        
        # Test connection to production PostgreSQL
        echo "🗄️ Testing PostgreSQL connection..."
        PGPASSWORD=${{ secrets.DB_PASSWORD }} psql \
          -h 221.132.33.141 \
          -U skillverse_user \
          -d skillverse_db \
          -c "SELECT version();" || {
            echo "❌ Failed to connect to PostgreSQL"
            exit 1
          }
        echo "✅ PostgreSQL connection successful!"
      continue-on-error: false
      
    - name: 🏗️ Build Application
      run: |
        ./mvnw clean package -DskipTests -q
        
    - name: 🚀 Start Application for API Docs
      run: |
        # Start app in background with production PostgreSQL
        echo "🚀 Starting application with production PostgreSQL..."
        java -jar target/*.jar \
          --spring.profiles.active=test \
          --spring.datasource.url=jdbc:postgresql://221.132.33.141:5432/skillverse_db \
          --spring.datasource.username=skillverse_user \
          --spring.datasource.password="${{ secrets.DB_PASSWORD }}" \
          --spring.datasource.driver-class-name=org.postgresql.Driver \
          --spring.jpa.hibernate.ddl-auto=validate \
          --spring.jpa.show-sql=false &
        APP_PID=$!
        echo $APP_PID > app.pid
        
        # Wait for startup with progress
        echo "⏳ Waiting for application startup..."
        for i in {1..60}; do
          if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
            echo "✅ Application is ready!"
            break
          fi
          echo "Waiting... ($i/60)"
          sleep 1
        done
        
        # Test health endpoint
        curl -f http://localhost:8080/actuator/health || {
          echo "❌ Health check failed"
          ps aux | grep java
          exit 1
        }
        
        # Download OpenAPI spec
        curl -f http://localhost:8080/v3/api-docs > api-docs.json || echo "Failed to get API docs"
        curl -f http://localhost:8080/v3/api-docs.yaml > api-docs.yaml || echo "Failed to get API docs YAML"
        
        # Stop application
        kill $APP_PID || true
      
    - name: 📊 Upload API Documentation
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: api-docs-${{ github.sha }}
        path: |
          ./api-docs.json
          ./api-docs.yaml
        retention-days: 30

  # Job 4: Docker Build (on main branch)
  docker-build:
    name: 🐳 Docker Build
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'maven'
        
    - name: 🐳 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 🔐 Make mvnw executable
      run: chmod +x mvnw
      
    - name: 🏗️ Build JAR
      run: |
        ./mvnw clean package -DskipTests -q
        
    - name: 🐳 Build Docker Image
      run: |
        docker build -t skillverse-backend:${{ github.sha }} .
        docker tag skillverse-backend:${{ github.sha }} skillverse-backend:latest
        
    - name: 🧪 Test Docker Image
      run: |
        # Start backend container with production PostgreSQL connection
        docker run -d --name test-backend \
          -p 8080:8080 \
          -e SPRING_PROFILES_ACTIVE=test \
          -e SPRING_DATASOURCE_URL=jdbc:postgresql://221.132.33.141:5432/skillverse_db \
          -e SPRING_DATASOURCE_USERNAME=skillverse_user \
          -e SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          -e SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver \
          -e SPRING_JPA_HIBERNATE_DDL_AUTO=validate \
          -e SPRING_JPA_SHOW_SQL=false \
          skillverse-backend:${{ github.sha }}
          
        echo "⏳ Waiting for application to start..."
        sleep 10
        
        # Check container status
        docker ps -a --filter name=test-backend
        
        # Check application logs
        echo "📋 Application logs:"
        docker logs test-backend --tail 50
        
        # Wait more and check if port is listening
        sleep 20
        netstat -tlnp | grep :8080 || echo "Port 8080 not listening"
        
        # Try health check with verbose output
        echo "🏥 Testing health endpoint..."
        curl -v -f http://localhost:8080/actuator/health || {
          echo "❌ Health check failed, showing more logs:"
          docker logs test-backend --tail 100
          exit 1
        }
        
        # Cleanup
        docker stop test-backend || true
        docker rm test-backend || true

  # Job 5: Deployment Status
  deployment-status:
    name: 📊 Deployment Status
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, api-docs, docker-build]
    if: always()
    
    steps:
    - name: 📊 Report Status
      run: |
        echo "## ☕ Backend CI/CD Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality Check**: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **API Docs**: ${{ needs.api-docs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Build**: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        
    - name: 💬 Comment on PR
      if: github.event_name == 'pull_request' && (failure() || success())
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.quality-check.result }}' === 'success' && 
                        '${{ needs.security-scan.result }}' === 'success' ? '✅' : '❌';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${status} **Backend CI/CD Results**
            
            - Quality Check: ${{ needs.quality-check.result }}
            - Security Scan: ${{ needs.security-scan.result }}
            - API Documentation: ${{ needs.api-docs.result }}
            - Docker Build: ${{ needs.docker-build.result }}
            - Commit: \`${{ github.sha }}\`
            
            ${status === '❌' ? '⚠️ Please fix the issues before merging.' : '🎉 All checks passed! Ready to merge.'}`
          })