name: â˜• Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  JAVA_VERSION: "21"
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  JWT_ACCESS_TOKEN_EXPIRATION: ${{ secrets.JWT_ACCESS_TOKEN_EXPIRATION }}
  JWT_REFRESH_TOKEN_EXPIRATION: ${{ secrets.JWT_REFRESH_TOKEN_EXPIRATION }}
  JWT_REFRESH_PEPPER: ${{ secrets.JWT_REFRESH_PEPPER }}
  JWT_ISSUER: ${{ secrets.JWT_ISSUER }}

  # Google OAuth2 Configuration
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

  # Email Configuration
  SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
  SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
  SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
  SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
  EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
  EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}

  # Gemini AI Configuration
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GEMINI_OPENAI_BASE_URL: ${{ secrets.GEMINI_OPENAI_BASE_URL }}
  GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
  GEMINI_FALLBACK_MODELS: ${{ secrets.GEMINI_FALLBACK_MODELS }}
  GEMINI_TEMPERATURE: ${{ secrets.GEMINI_TEMPERATURE }}
  GEMINI_MAX_TOKENS: ${{ secrets.GEMINI_MAX_TOKENS }}
  GEMINI_ENABLED: ${{ secrets.GEMINI_ENABLED }}

  # Mistral AI Configuration
  MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
  MISTRAL_API_MODEL: ${{ secrets.MISTRAL_API_MODEL }}
  MISTRAL_ENABLED: ${{ secrets.MISTRAL_ENABLED }}
  MISTRAL_API_MAX_TOKENS: ${{ secrets.MISTRAL_API_MAX_TOKENS }}
  MISTRAL_API_TEMPERATURE: ${{ secrets.MISTRAL_API_TEMPERATURE }}

  # Meowl Chat Configuration
  MEOWL_GEMINI_API_KEY: ${{ secrets.MEOWL_GEMINI_API_KEY }}
  MEOWL_REMINDER_ENABLED: ${{ secrets.MEOWL_REMINDER_ENABLED }}
  MEOWL_NOTIFICATION_ENABLED: ${{ secrets.MEOWL_NOTIFICATION_ENABLED }}

  # Portfolio CV Generation AI Configuration
  PORTFOLIO_MISTRAL_API_KEY: ${{ secrets.PORTFOLIO_MISTRAL_API_KEY }}
  PORTFOLIO_MISTRAL_API_BASE_URL: ${{ secrets.PORTFOLIO_MISTRAL_API_BASE_URL }}
  PORTFOLIO_MISTRAL_API_MODEL: ${{ secrets.PORTFOLIO_MISTRAL_API_MODEL }}
  PORTFOLIO_MISTRAL_ENABLED: ${{ secrets.PORTFOLIO_MISTRAL_ENABLED }}
  PORTFOLIO_MISTRAL_API_TIMEOUT: ${{ secrets.PORTFOLIO_MISTRAL_API_TIMEOUT }}
  PORTFOLIO_MISTRAL_API_MAX_TOKENS: ${{ secrets.PORTFOLIO_MISTRAL_API_MAX_TOKENS }}
  PORTFOLIO_MISTRAL_API_TEMPERATURE: ${{ secrets.PORTFOLIO_MISTRAL_API_TEMPERATURE }}

  # Payment Gateway Configuration (PayOS)
  PAYOS_CLIENT_ID: ${{ secrets.PAYOS_CLIENT_ID }}
  PAYOS_API_KEY: ${{ secrets.PAYOS_API_KEY }}
  PAYOS_CHECKSUM_KEY: ${{ secrets.PAYOS_CHECKSUM_KEY }}
  PAYOS_BASE_URL: ${{ secrets.PAYOS_BASE_URL }}
  PAYOS_WEBHOOK_URL: ${{ secrets.PAYOS_WEBHOOK_URL }}

  # Premium Subscription Configuration
  PREMIUM_AUTO_CREATE_PLANS: ${{ secrets.PREMIUM_AUTO_CREATE_PLANS }}

  # Cloudinary Configuration
  CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
  CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
  CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
  CLOUDINARY_URL: ${{ secrets.CLOUDINARY_URL }}

  # CORS Configuration
  CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
  CORS_ALLOWED_METHODS: ${{ secrets.CORS_ALLOWED_METHODS }}
  CORS_ALLOWED_HEADERS: ${{ secrets.CORS_ALLOWED_HEADERS }}
  CORS_ALLOW_CREDENTIALS: ${{ secrets.CORS_ALLOW_CREDENTIALS }}
  CORS_MAX_AGE: ${{ secrets.CORS_MAX_AGE }}

  # Jackson Configuration
  SPRING_JACKSON_TIME_ZONE: ${{ secrets.SPRING_JACKSON_TIME_ZONE }}
  SPRING_JACKSON_DATE_FORMAT: ${{ secrets.SPRING_JACKSON_DATE_FORMAT }}

  # Swagger Configuration
  SPRINGDOC_API_DOCS_ENABLED: ${{ secrets.SPRINGDOC_API_DOCS_ENABLED }}
  SPRINGDOC_SWAGGER_UI_ENABLED: ${{ secrets.SPRINGDOC_SWAGGER_UI_ENABLED }}
  SPRINGDOC_API_DOCS_PATH: ${{ secrets.SPRINGDOC_API_DOCS_PATH }}
  SPRINGDOC_SWAGGER_UI_PATH: ${{ secrets.SPRINGDOC_SWAGGER_UI_PATH }}

jobs:
  # Job 1: Code Quality & Testing
  quality-check:
    name: ğŸ” Code Quality & Testing
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: ğŸ” Make mvnw executable
        run: chmod +x mvnw

      - name: ğŸ“¦ Compile & Package
        run: |
          ./mvnw clean compile -q
          ./mvnw package -DskipTests -q

      - name: ğŸ§ª Run Unit Tests
        run: |
          # Run tests with H2 for unit tests (faster)
          ./mvnw test \
            -Dspring.datasource.url=jdbc:h2:mem:testdb \
            -Dspring.datasource.username=sa \
            -Dspring.datasource.password=password \
            -Dspring.datasource.driver-class-name=org.h2.Driver \
            -Dspring.jpa.hibernate.ddl-auto=create-drop

      - name: ğŸ“Š Test Coverage Report
        run: |
          ./mvnw jacoco:report
        continue-on-error: true

      - name: ğŸ“ˆ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            ./target/surefire-reports/
            ./target/site/jacoco/
          retention-days: 7

      - name: ğŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: backend-jar-${{ github.sha }}
          path: ./target/*.jar
          retention-days: 7

  # Job 2: Security & Dependency Check
  security-scan:
    name: ğŸ”’ Security & Dependency Scan
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: ğŸ” Make mvnw executable
        run: chmod +x mvnw

      - name: ğŸ” OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check
        continue-on-error: true

  # Job 3: API Documentation & Swagger
  api-docs:
    name: ğŸ“š API Documentation
    runs-on: ubuntu-latest
    needs: quality-check

    # Add Redis service for the application
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5


    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: ğŸ” Make mvnw executable
        run: chmod +x mvnw

      - name: ğŸ—„ï¸ Test PostgreSQL Connection
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Install PostgreSQL client
          sudo apt-get update
          sudo apt-get install -y postgresql-client

          # Debug: Check if secret is available
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "âŒ DB_PASSWORD secret is empty or not available"
            echo "This could be a permission issue with repository secrets"
            exit 1
          else
            echo "âœ… DB_PASSWORD secret is available"
          fi

          # Test connection to production PostgreSQL
          echo "ğŸ—„ï¸ Testing PostgreSQL connection..."
          psql \
            -h 221.132.33.141 \
            -U skillverse_user \
            -d skillverse_db \
            -c "SELECT version();" || {
              echo "âŒ Failed to connect to PostgreSQL"
              exit 1
            }
          echo "âœ… PostgreSQL connection successful!"
        continue-on-error: false

      - name: ğŸ—ï¸ Build Application
        run: |
          ./mvnw clean package -DskipTests -q

      - name: ğŸš€ Start Application for API Docs
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Start app in background with docker profile and production PostgreSQL
          echo "ğŸš€ Starting application with docker profile..."
          
          # Start application with explicit configuration for CI environment
          java -jar target/*.jar \
            --spring.profiles.active=docker \
            --server.port=8080 \
            --server.address=0.0.0.0 \
            --spring.data.redis.host=localhost \
            --spring.data.redis.port=6379 \
            --logging.level.root=INFO \
            --logging.level.com.exe.skillverse_backend=DEBUG > app.log 2>&1 &
          
          APP_PID=$!
          echo "ğŸ“ Application PID: $APP_PID"
          echo $APP_PID > app.pid

          # Wait for startup with enhanced retry logic
          echo "â³ Waiting for application startup (up to 3 minutes)..."
          HEALTH_CHECK_PASSED=false
          
          for i in {1..36}; do
            echo "Attempt $i/36: Checking health endpoint..."
            
            # Check if process is still running
            if ! kill -0 $APP_PID 2>/dev/null; then
              echo "âŒ Application process died! Last 50 lines of logs:"
              tail -n 50 app.log
              exit 1
            fi
            
            # Try health check
            if curl -f -s http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… Application is ready!"
              HEALTH_CHECK_PASSED=true
              break
            fi
            
            echo "â³ Not ready yet, waiting 5 seconds... (${i}/36)"
            sleep 5
          done

          # Verify health check passed
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo "âŒ Health check failed after 3 minutes. Application logs:"
            cat app.log
            echo ""
            echo "Process status:"
            ps aux | grep java
            echo ""
            echo "Port status:"
            netstat -tlnp 2>/dev/null | grep 8080 || echo "Port 8080 not listening"
            kill $APP_PID 2>/dev/null || true
            exit 1
          fi

          # Display successful health check
          echo "ğŸ¥ Health check response:"
          curl -s http://localhost:8080/actuator/health | jq '.' || curl -s http://localhost:8080/actuator/health

          # Download OpenAPI spec
          echo "ğŸ“¥ Downloading API documentation..."
          if curl -f -s http://localhost:8080/v3/api-docs > api-docs.json; then
            echo "âœ… Downloaded api-docs.json ($(wc -c < api-docs.json) bytes)"
          else
            echo "âš ï¸ Failed to download api-docs.json"
          fi
          
          if curl -f -s http://localhost:8080/v3/api-docs.yaml > api-docs.yaml; then
            echo "âœ… Downloaded api-docs.yaml ($(wc -c < api-docs.yaml) bytes)"
          else
            echo "âš ï¸ Failed to download api-docs.yaml"
          fi

          # Stop application gracefully
          echo "ğŸ›‘ Stopping application..."
          kill $APP_PID 2>/dev/null || true
          sleep 3
          kill -9 $APP_PID 2>/dev/null || true

      - name: ğŸ“Š Upload API Documentation
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: api-docs-${{ github.sha }}
          path: |
            ./api-docs.json
            ./api-docs.yaml
          retention-days: 30

  # Job 4: Docker Build (on main branch)
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Make mvnw executable
        run: chmod +x mvnw

      - name: ğŸ—ï¸ Build JAR
        run: |
          ./mvnw clean package -DskipTests -q

      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t skillverse-backend:${{ github.sha }} .
          docker tag skillverse-backend:${{ github.sha }} skillverse-backend:latest
          docker tag skillverse-backend:${{ github.sha }} skillverse-backend:v1

      - name: ğŸ§ª Test Docker Image
        run: |
          # Start Redis for the test
          echo "ğŸš€ Starting Redis container..."
          docker run -d --name test-redis \
            -p 6379:6379 \
            redis:7-alpine
          
          # Wait for Redis to be ready
          sleep 5
          
          # Start backend container with all environment variables
          echo "ğŸš€ Starting backend container..."
          docker run -d --name test-backend \
            -p 8080:8080 \
            --link test-redis:redis \
            -e SPRING_PROFILES_ACTIVE=docker \
            -e SPRING_DATASOURCE_URL=jdbc:postgresql://221.132.33.141:5432/skillverse_db \
            -e SPRING_DATASOURCE_USERNAME=skillverse_user \
            -e SPRING_DATASOURCE_PASSWORD="${DB_PASSWORD}" \
            -e SPRING_JPA_HIBERNATE_DDL_AUTO=validate \
            -e SPRING_DATA_REDIS_HOST=redis \
            -e SPRING_DATA_REDIS_PORT=6379 \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e JWT_ACCESS_TOKEN_EXPIRATION="${JWT_ACCESS_TOKEN_EXPIRATION}" \
            -e JWT_REFRESH_TOKEN_EXPIRATION="${JWT_REFRESH_TOKEN_EXPIRATION}" \
            -e GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}" \
            -e GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}" \
            -e SPRING_MAIL_HOST="${SPRING_MAIL_HOST}" \
            -e SPRING_MAIL_PORT="${SPRING_MAIL_PORT}" \
            -e SPRING_MAIL_USERNAME="${SPRING_MAIL_USERNAME}" \
            -e SPRING_MAIL_PASSWORD="${SPRING_MAIL_PASSWORD}" \
            -e EMAIL_FROM="${EMAIL_FROM}" \
            -e EMAIL_FROM_NAME="${EMAIL_FROM_NAME}" \
            -e GEMINI_API_KEY="${GEMINI_API_KEY}" \
            -e GEMINI_OPENAI_BASE_URL="${GEMINI_OPENAI_BASE_URL}" \
            -e GEMINI_MODEL="${GEMINI_MODEL}" \
            -e GEMINI_FALLBACK_MODELS="${GEMINI_FALLBACK_MODELS}" \
            -e GEMINI_TEMPERATURE="${GEMINI_TEMPERATURE}" \
            -e GEMINI_MAX_TOKENS="${GEMINI_MAX_TOKENS}" \
            -e GEMINI_ENABLED="${GEMINI_ENABLED}" \
            -e MISTRAL_API_KEY="${MISTRAL_API_KEY}" \
            -e MISTRAL_API_MODEL="${MISTRAL_API_MODEL}" \
            -e MISTRAL_ENABLED="${MISTRAL_ENABLED}" \
            -e MISTRAL_API_MAX_TOKENS="${MISTRAL_API_MAX_TOKENS}" \
            -e MISTRAL_API_TEMPERATURE="${MISTRAL_API_TEMPERATURE}" \
            -e MEOWL_REMINDER_ENABLED="${MEOWL_REMINDER_ENABLED}" \
            -e MEOWL_NOTIFICATION_ENABLED="${MEOWL_NOTIFICATION_ENABLED}" \
            -e PAYOS_CLIENT_ID="${PAYOS_CLIENT_ID}" \
            -e PAYOS_API_KEY="${PAYOS_API_KEY}" \
            -e PAYOS_CHECKSUM_KEY="${PAYOS_CHECKSUM_KEY}" \
            -e PAYOS_BASE_URL="${PAYOS_BASE_URL}" \
            -e PAYOS_WEBHOOK_URL="${PAYOS_WEBHOOK_URL}" \
            -e PREMIUM_AUTO_CREATE_PLANS="${PREMIUM_AUTO_CREATE_PLANS}" \
            -e CLOUDINARY_CLOUD_NAME="${CLOUDINARY_CLOUD_NAME}" \
            -e CLOUDINARY_API_KEY="${CLOUDINARY_API_KEY}" \
            -e CLOUDINARY_API_SECRET="${CLOUDINARY_API_SECRET}" \
            -e CLOUDINARY_URL="${CLOUDINARY_URL}" \
            -e CORS_ALLOWED_ORIGINS="${CORS_ALLOWED_ORIGINS}" \
            -e CORS_ALLOWED_METHODS="${CORS_ALLOWED_METHODS}" \
            -e CORS_ALLOWED_HEADERS="${CORS_ALLOWED_HEADERS}" \
            -e CORS_ALLOW_CREDENTIALS="${CORS_ALLOW_CREDENTIALS}" \
            -e CORS_MAX_AGE="${CORS_MAX_AGE}" \
            -e SPRING_JACKSON_TIME_ZONE="${SPRING_JACKSON_TIME_ZONE}" \
            -e SPRING_JACKSON_DATE_FORMAT="${SPRING_JACKSON_DATE_FORMAT}" \
            -e SPRINGDOC_API_DOCS_ENABLED="${SPRINGDOC_API_DOCS_ENABLED}" \
            -e SPRINGDOC_SWAGGER_UI_ENABLED="${SPRINGDOC_SWAGGER_UI_ENABLED}" \
            -e SPRINGDOC_API_DOCS_PATH="${SPRINGDOC_API_DOCS_PATH}" \
            -e SPRINGDOC_SWAGGER_UI_PATH="${SPRINGDOC_SWAGGER_UI_PATH}" \
            skillverse-backend:${{ github.sha }}
            
          echo "â³ Waiting for application to start..."

          # Enhanced health check with retry logic
          HEALTH_CHECK_PASSED=false
          for i in {1..30}; do
            echo "Health check attempt $i/30..."
            
            # Check if container is still running
            if ! docker ps | grep -q test-backend; then
              echo "âŒ Container stopped unexpectedly!"
              docker ps -a --filter name=test-backend
              docker logs test-backend --tail 100
              exit 1
            fi
            
            # Try health check
            if curl -f -s http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… Health check passed!"
              HEALTH_CHECK_PASSED=true
              break
            fi
            
            echo "â³ Not ready yet, waiting 5 seconds... ($i/30)"
            sleep 5
          done

          # Verify health check passed
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo "âŒ Health check failed after 2.5 minutes"
            echo "ğŸ“‹ Container status:"
            docker ps -a --filter name=test-backend
            echo ""
            echo "ğŸ“‹ Application logs (full):"
            docker logs test-backend || true
            echo ""
            echo "ğŸ“‹ Environment variables passed to container:"
            docker inspect --format='{{json .Config.Env}}' test-backend || true
            echo ""
            echo "ğŸ“‹ Port status:"
            netstat -tlnp 2>/dev/null | grep :8080 || echo "Port 8080 not listening"
            docker stop test-backend test-redis || true
            docker rm test-backend test-redis || true
            exit 1
          fi

          # Display health response
          echo "ğŸ¥ Health check response:"
          curl -s http://localhost:8080/actuator/health | jq '.' || curl -s http://localhost:8080/actuator/health

          # Cleanup
          echo "ğŸ§¹ Cleaning up containers..."
          docker stop test-backend test-redis || true
          docker rm test-backend test-redis || true
          echo "âœ… Docker test completed successfully!"

  # Job 5: Deploy to VPS
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, api-docs, docker-build]
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ğŸ”§ Deploy to VPS
        run: |
          VPS_HOST="${{ secrets.VPS_HOST }}"
          VPS_USER="${{ secrets.VPS_USER }}"
          VPS_PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"

          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "ğŸš€ Starting backend deployment..."
            cd ${{ secrets.VPS_PROJECT_PATH }}
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            
            # Update .env with new secrets if missing
            echo "ğŸ”§ Updating .env with required secrets..."
            grep -q "MEOWL_GEMINI_API_KEY" .env || echo "MEOWL_GEMINI_API_KEY=${{ secrets.MEOWL_GEMINI_API_KEY }}" >> .env
            grep -q "PORTFOLIO_MISTRAL_API_KEY" .env || echo "PORTFOLIO_MISTRAL_API_KEY=${{ secrets.PORTFOLIO_MISTRAL_API_KEY }}" >> .env
            grep -q "PORTFOLIO_MISTRAL_API_BASE_URL" .env || echo "PORTFOLIO_MISTRAL_API_BASE_URL=${{ secrets.PORTFOLIO_MISTRAL_API_BASE_URL }}" >> .env
            grep -q "PORTFOLIO_MISTRAL_API_MODEL" .env || echo "PORTFOLIO_MISTRAL_API_MODEL=${{ secrets.PORTFOLIO_MISTRAL_API_MODEL }}" >> .env
            grep -q "PORTFOLIO_MISTRAL_ENABLED" .env || echo "PORTFOLIO_MISTRAL_ENABLED=${{ secrets.PORTFOLIO_MISTRAL_ENABLED }}" >> .env
            
            # Stop and remove old backend container only
            docker compose stop backend 2>/dev/null || true
            docker compose rm -f backend 2>/dev/null || true
            
            # Remove old backend images
            docker images | grep backend | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Build new backend image
            docker build -t skillverse-backend:v1 .
            
            # Start ONLY backend (without recreating db/redis)
            docker compose --compatibility up -d --no-recreate backend
            
            # Wait for backend to be ready
            echo "â³ Waiting for backend to start..."
            sleep 60
            
            # Check backend health
            curl -f http://localhost:8080/actuator/health || {
              echo "âŒ Backend health check failed, showing logs:"
              docker compose logs --tail=50 backend
              exit 1
            }
            
            echo "âœ… Backend deployed successfully!"
            
            # Clean up unused images and containers
            docker system prune -f
          ENDSSH

  # Job 6: Deployment Status
  deployment-status:
    name: ğŸ“Š Deployment Status
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, api-docs, docker-build, deploy]
    if: always()

    steps:
      - name: ğŸ“Š Report Status
        run: |
          echo "## â˜• Backend CI/CD Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Check**: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs**: ${{ needs.api-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Build**: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && (failure() || success())
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.quality-check.result }}' === 'success' && 
                          '${{ needs.security-scan.result }}' === 'success' ? 'âœ…' : 'âŒ';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status} **Backend CI/CD Results**
              
              - Quality Check: ${{ needs.quality-check.result }}
              - Security Scan: ${{ needs.security-scan.result }}
              - API Documentation: ${{ needs.api-docs.result }}
              - Docker Build: ${{ needs.docker-build.result }}
              - Deployment: ${{ needs.deploy.result }}
              - Commit: \`${{ github.sha }}\`
              
              ${status === 'âŒ' ? 'âš ï¸ Please fix the issues before merging.' : 'ğŸ‰ All checks passed! Ready to merge.'}`
            })
